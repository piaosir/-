<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>卫星通信链路可视化与计算系统</title>
    <!-- 添加FontAwesome图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: "微软雅黑", Arial, sans-serif;
            transition: background 0.3s;
        }
        #container {
            position: relative;
            width: 100%;
            height: 100vh;
        }
        
        /* 统一控制面板样式 */
        #unified-control-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 100;
            width: 320px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            transition: transform 0.3s ease-in-out;
        }
        
        .panel-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }
        
        .panel-section h4 {
            margin: 8px 0;
            color: #4285f4;
            font-size: 14px;
        }
        
        .panel-section h3 {
            margin: 0 0 15px 0;
            color: #ffffff;
            font-size: 18px;
            text-align: center;
        }
        
        .slider-container {
            margin: 10px 0;
        }
        
        label {
            display: inline-block;
            width: 140px;
            font-size: 13px;
        }
        
        input[type="range"] {
            width: 120px;
        }
        
        .value-display {
            display: inline-block;
            width: 40px;
            text-align: right;
            font-size: 13px;
        }
        
        /* 可折叠部分样式 */
        .collapsible-section .section-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .toggle-indicator {
            transition: transform 0.3s;
        }

        .section-collapsed .toggle-indicator {
            transform: rotate(-90deg);
        }

        .section-collapsed .section-content {
            display: none;
        }
        
        /* 表格样式 */
        #link-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        #link-table th, #link-table td {
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 5px;
            text-align: center;
            font-size: 13px;
        }

        #link-table th {
            background-color: rgba(66, 133, 244, 0.2);
        }

        #link-table .highlight-row {
            background-color: rgba(66, 133, 244, 0.1);
            font-weight: bold;
        }
        
        /* 计算结果样式 */
        #calculation-results {
            background-color: rgba(66, 133, 244, 0.2);
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
        }
        
        /* 链路质量指示器 */
        .link-quality-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .link-quality-good {
            background-color: #34a853;
        }
        
        .link-quality-medium {
            background-color: #fbbc05;
        }
        
        .link-quality-poor {
            background-color: #ea4335;
        }
        
        /* 按钮样式 */
        #calculateBtn, .report-button {
            width: 100%;
            padding: 8px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        #calculateBtn {
            background-color: #4285f4;
        }
        
        #calculateBtn:hover {
            background-color: #3367d6;
        }
        
        .report-button {
            background-color: #34a853;
        }
        
        .report-button:hover {
            background-color: #2d8e47;
        }
        
        /* 面板切换按钮 */
        #toggle-panel-button {
            position: absolute;
            top: 10px;
            left: 330px; /* 位于控制面板右侧 */
            z-index: 101;
        }

        #togglePanel {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        #togglePanel:hover {
            background: rgba(66, 133, 244, 0.8);
        }

        .panel-hidden #unified-control-panel {
            transform: translateX(-340px);
        }

        .panel-hidden #toggle-panel-button {
            left: 10px;
        }

        .panel-hidden #toggle-icon {
            transform: rotate(180deg);
        }
        
        /* 快捷操作区域 */
        #quick-actions {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 101;
        }

        #quick-actions button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        #quick-actions button:hover {
            background: rgba(66, 133, 244, 0.8);
        }
        
        /* 地面站标签 */
        .station-label {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            pointer-events: none;
            position: absolute;
            z-index: 100;
            white-space: nowrap;
        }

        .station-label.draggable:after {
            content: " [可拖动]";
            color: #4CAF50;
        }
        
        /* 参数项目样式 */
        .param-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        
        .param-item label {
            width: 160px;
            font-size: 13px;
            color: #e0e0e0;
        }
        
        .param-item input[type="number"],
        .param-item select {
            flex: 1;
            padding: 5px 8px;
            border: 1px solid #555;
            border-radius: 3px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 13px;
        }
        
        .param-item input[type="number"]:focus,
        .param-item select:focus {
            border-color: #4285f4;
            outline: none;
        }
        
        /* 继承原有的其他样式 */
        .switch-container {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
            margin-left: 10px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #2196F3;
        }
        
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        
        #satellite-info {
            position: absolute;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            border-radius: 3px;
            font-size: 12px;
            pointer-events: none;
            z-index: 100;
        }
        
        #instruction-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.5;
            max-width: 400px;
            z-index: 200;
            text-align: center;
            display: none;
        }
        
        #instruction-panel button {
            background: #4285f4;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        #legend {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 8px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 100;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            border-radius: 2px;
        }
        
        .mouse-guide {
            position: absolute;
            bottom: 120px;
            right: 20px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 8px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 100;
        }
        
        /* 拖动信息提示 */
        #drag-info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            font-size: 14px;
            display: none;
        }
    </style>
</head>
<body>
    <div id="container">
        <!-- 统一控制面板 -->
        <div id="unified-control-panel">
            <h3>卫星链路可视化与计算系统</h3>
            
            <div class="panel-section collapsible-section">
                <div class="section-header" onclick="toggleSection('link-info')">
                    <h4>链路信息</h4>
                    <span class="toggle-indicator">▼</span>
                </div>
                <div id="link-info" class="section-content">
                    <div>上行距离: <span id="uplink-distance">0</span> km</div>
                    <div>下行距离: <span id="downlink-distance">0</span> km</div>
                    <div>总延迟: <span id="delay">0</span> ms</div>
                    <div>上行损耗: <span id="uplink-fsl">0</span> dB</div>
                    <div>下行损耗: <span id="downlink-fsl">0</span> dB</div>
                </div>
            </div>
            
            <div class="panel-section collapsible-section">
                <div class="section-header" onclick="toggleSection('satellite-info-section')">
                    <h4>卫星信息</h4>
                    <span class="toggle-indicator">▼</span>
                </div>
                <div id="satellite-info-section" class="section-content">
                    <div class="param-item">
                        <label for="satelliteSelector">卫星名称</label>
                        <select id="satelliteSelector">
                            <option value="自定义卫星">自定义卫星</option>
                            <option value="CHINASAT 6D (125°E)">CHINASAT 6D (125°E)</option>
                            <option value="CHINASAT 6C (130°E)">CHINASAT 6C (130°E)</option>
                            <option value="CHINASAT 6E (115.5°E)">CHINASAT 6E (115.5°E)</option>
                            <option value="CHINASAT 9 (92.2°E)">CHINASAT 9 (92.2°E)</option>
                            <option value="CHINASAT 9B (101.4°E)">CHINASAT 9B (101.4°E)</option>
                            <option value="CHINASAT 10 (110.5°E)">CHINASAT 10 (110.5°E)</option>
                            <option value="CHINASAT 11 (98°E)">CHINASAT 11 (98°E)</option>
                            <option value="CHINASAT 12 (87.5°E)">CHINASAT 12 (87.5°E)</option>
                            <option value="CHINASAT 15 (51.5°E)">CHINASAT 15 (51.5°E)</option>
                        </select>
                    </div>
                    <div class="param-item">
                        <label for="frequencyBand">工作频段</label>
                        <select id="frequencyBand">
                            <option value="Ku">Ku 频段</option>
                            <option value="C">C 频段</option>
                            <option value="DBS">DBS 频段</option>
                            <option value="ExtC">扩展C频段</option>
                            <option value="ExtKu">扩展Ku频段</option>
                        </select>
                    </div>
                    <div class="param-item">
                        <label for="transponderBandwidth">转发器带宽 (MHz)</label>
                        <input type="number" id="transponderBandwidth" value="36" min="1" max="100">
                    </div>
                    <div class="switch-container">
                        <span>显示经纬度网格:</span>
                        <label class="switch">
                            <input type="checkbox" id="gridToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="panel-section collapsible-section">
                <div class="section-header" onclick="toggleSection('params-control')">
                    <h4>参数控制</h4>
                    <span class="toggle-indicator">▼</span>
                </div>
                <div id="params-control" class="section-content">
                    <div class="slider-container">
                        <label for="orbitHeight">轨道高度:</label>
                        <input type="range" id="orbitHeight" min="1000" max="40000" step="100" value="35786">
                        <span class="value-display" id="orbitHeightValue">35786</span> km
                    </div>
                    
                    <div style="margin-top: 10px; font-size: 12px; color: #aaa; text-align: center;">
                        可以直接在3D地图上拖动地面站来更改位置
                    </div>
                    
                    <div class="slider-container">
                        <label for="upLatitude">上行站纬度:</label>
                        <input type="range" id="upLatitude" min="-90" max="90" step="0.01" value="39.9">
                        <span class="value-display" id="upLatitudeValue">39.9</span>°
                    </div>
                    
                    <div class="slider-container">
                        <label for="upLongitude">上行站经度:</label>
                        <input type="range" id="upLongitude" min="-180" max="180" step="0.01" value="116.4">
                        <span class="value-display" id="upLongitudeValue">116.4</span>°
                    </div>
                    
                    <div class="slider-container">
                        <label for="downLatitude">接收站纬度:</label>
                        <input type="range" id="downLatitude" min="-90" max="90" step="0.01" value="31.23">
                        <span class="value-display" id="downLatitudeValue">31.23</span>°
                    </div>
                    
                    <div class="slider-container">
                        <label for="downLongitude">接收站经度:</label>
                        <input type="range" id="downLongitude" min="-180" max="180" step="0.01" value="121.47">
                        <span class="value-display" id="downLongitudeValue">121.47</span>°
                    </div>
                    
                    <div class="slider-container">
                        <label for="frequency">频率:</label>
                        <input type="range" id="frequency" min="1" max="40" step="0.1" value="12">
                        <span class="value-display" id="frequencyValue">12</span> GHz
                    </div>
                    
                    <div class="slider-container">
                        <label for="bandwidth">带宽:</label>
                        <input type="range" id="bandwidth" min="1" max="100" step="1" value="36">
                        <span class="value-display" id="bandwidthValue">36</span> MHz
                    </div>
                    
                    <div class="slider-container">
                        <label for="txPower">发射功率:</label>
                        <input type="range" id="txPower" min="0" max="50" step="0.1" value="10">
                        <span class="value-display" id="txPowerValue">10</span> W
                    </div>
                    
                    <div class="slider-container">
                        <label for="txAntenna">发射天线直径:</label>
                        <input type="range" id="txAntenna" min="0.1" max="10" step="0.1" value="2">
                        <span class="value-display" id="txAntennaValue">2</span> m
                    </div>
                    
                    <div class="slider-container">
                        <label for="rxAntenna">接收天线直径:</label>
                        <input type="range" id="rxAntenna" min="0.1" max="10" step="0.1" value="3">
                        <span class="value-display" id="rxAntennaValue">3</span> m
                    </div>
                    
                    <div class="param-item">
                        <label for="uplinkPolarization">上行极化</label>
                        <select id="uplinkPolarization">
                            <option value="V">垂直极化 (V)</option>
                            <option value="H">水平极化 (H)</option>
                            <option value="C">圆极化 (C)</option>
                        </select>
                    </div>
                    
                    <div class="param-item">
                        <label for="modulationType">调制方式</label>
                        <select id="modulationType">
                            <option value="QPSK">QPSK</option>
                            <option value="8PSK">8PSK</option>
                            <option value="16QAM">16QAM</option>
                            <option value="BPSK">BPSK</option>
                        </select>
                    </div>
                    
                    <div class="param-item">
                        <label for="FEC">前向纠错编码</label>
                        <select id="FEC">
                            <option value="1/2">1/2</option>
                            <option value="2/3">2/3</option>
                            <option value="3/4">3/4</option>
                            <option value="5/6">5/6</option>
                            <option value="7/8">7/8</option>
                            <option value="9/10">9/10</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="panel-section collapsible-section">
                <div class="section-header" onclick="toggleSection('link-parameters')">
                    <h4>链路参数表</h4>
                    <span class="toggle-indicator">▼</span>
                </div>
                <div id="link-parameters" class="section-content">
                    <table id="link-table">
                        <thead>
                            <tr>
                                <th>参数</th>
                                <th>上行链路</th>
                                <th>下行链路</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>距离</td>
                                <td id="table-uplink-distance">0</td>
                                <td id="table-downlink-distance">0</td>
                            </tr>
                            <tr>
                                <td>自由空间损耗</td>
                                <td id="table-uplink-fsl">0</td>
                                <td id="table-downlink-fsl">0</td>
                            </tr>
                            <tr>
                                <td>延迟</td>
                                <td id="table-uplink-delay">0</td>
                                <td id="table-downlink-delay">0</td>
                            </tr>
                            <tr>
                                <td>C/N</td>
                                <td id="table-cnr-up">0</td>
                                <td id="table-cnr-down">0</td>
                            </tr>
                            <tr class="highlight-row">
                                <td>总C/N</td>
                                <td colspan="2" id="table-cnr-total">0</td>
                            </tr>
                            <tr class="highlight-row">
                                <td>Eb/N₀</td>
                                <td colspan="2" id="table-ebno">0</td>
                            </tr>
                            <tr class="highlight-row">
                                <td>误码率</td>
                                <td colspan="2" id="table-ber">0</td>
                            </tr>
                            <tr class="highlight-row">
                                <td>链路余量</td>
                                <td colspan="2" id="table-margin">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="panel-section">
                <h4>计算结果</h4>
                <div id="calculation-results">
                    <div><span class="link-quality-indicator" id="ebno-indicator"></span>Eb/N₀: <span id="ebno">0</span> dB</div>
                    <div>误码率: <span id="ber">0</span></div>
                    <div><span class="link-quality-indicator" id="margin-indicator"></span>链路余量: <span id="margin">0</span> dB</div>
                    <div>上行C/N: <span id="cnr-up">0</span> dB</div>
                    <div>下行C/N: <span id="cnr-down">0</span> dB</div>
                    <div>总C/N: <span id="cnr-total">0</span> dB</div>
                </div>
                <button id="calculateBtn">计算链路预算</button>
                <button id="reportBtn" class="report-button">生成链路报告</button>
            </div>
        </div>

        <!-- 面板切换按钮 -->
        <div id="toggle-panel-button">
            <button id="togglePanel">
                <span id="toggle-icon">◀</span>
            </button>
        </div>

        <!-- 快捷操作区域 -->
        <div id="quick-actions">
            <button id="quick-calculate" title="计算链路预算">
                <i class="fas fa-calculator"></i>
            </button>
            <button id="quick-reset" title="重置视角">
                <i class="fas fa-home"></i>
            </button>
            <button id="quick-report" title="生成报告">
                <i class="fas fa-file-alt"></i>
            </button>
        </div>
        
        <!-- 拖动提示信息 -->
        <div id="drag-info"></div>
        
        <!-- 卫星信息显示 -->
        <div id="satellite-info"></div>
        
        <!-- 操作指南 -->
        <div id="instruction-panel">
            <h3>操作指南</h3>
            <p>点击卫星可以进入移动模式，此时可以：</p>
            <ul style="text-align:left">
                <li>拖动卫星可以改变其轨道位置</li>
                <li>使用鼠标滚轮可以微调卫星位置(每次±0.1°)</li>
                <li>双击卫星可以锁定/解锁当前位置</li>
            </ul>
            <p>点击并拖动地面站可以调整其位置</p>
            <p>点击地球其他位置可退出卫星移动模式</p>
            <button id="closeInstructions">知道了</button>
        </div>
        
        <!-- 图例 -->
        <div id="legend">
            <h4 style="margin-top:0;margin-bottom:5px">图例</h4>
            <div class="legend-item">
                <div class="legend-color" style="background-color:#00ff00"></div>
                <span>上行链路</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color:#ff0000"></div>
                <span>下行链路</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color:#ffff00"></div>
                <span>赤道</span>
            </div>
        </div>
        
        <!-- 鼠标操作指南 -->
        <div class="mouse-guide">
            <div>鼠标操作:</div>
            <div>- 左键点击卫星：选中/取消选中</div>
            <div>- 选中后拖动：移动卫星</div>
            <div>- 选中后滚轮：微调位置(±0.1°)</div>
            <div>- 双击卫星：锁定/解锁位置</div>
            <div>- 拖动地面站：调整位置</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script>
        // 初始化场景
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000033);
        
        // 初始化相机
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100000);
        camera.position.set(0, 20000, 30000);
        
        // 初始化渲染器
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('container').appendChild(renderer.domElement);
        
        // 添加轨道控制器
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        
        // 添加环境光（移除定向光以减少阴影效果）
        const ambientLight = new THREE.AmbientLight(0xffffff, 1.0);
        scene.add(ambientLight);
        
        // 地球半径(km)
        const EARTH_RADIUS = 6371;
        
        // 可用卫星名称列表
        const satelliteNames = [
            "CHINASAT 6D (125°E)",
            "CHINASAT 6C (130°E)",
            "CHINASAT 6E (115.5°E)",
            "CHINASAT 9 (92.2°E)",
            "CHINASAT 9B (101.4°E)",
            "CHINASAT 9C (92.2°E)",
            "CHINASAT 10 (110.5°E)",
            "CHINASAT 11 (98°E)",
            "CHINASAT 12 (87.5°E)",
            "CHINASAT 15 (51.5°E)",
            "自定义卫星"
        ];
        
        // 卫星位置数据（经度，东经为正）
        const satellitePositions = {
            "CHINASAT 6D (125°E)": 125,
            "CHINASAT 6C (130°E)": 130,
            "CHINASAT 6E (115.5°E)": 115.5,
            "CHINASAT 9 (92.2°E)": 92.2,
            "CHINASAT 9B (101.4°E)": 101.4,
            "CHINASAT 9C (92.2°E)": 92.2,
            "CHINASAT 10 (110.5°E)": 110.5,
            "CHINASAT 11 (98°E)": 98,
            "CHINASAT 12 (87.5°E)": 87.5,
            "CHINASAT 15 (51.5°E)": 51.5,
            "自定义卫星": 116.4
        };
        
        // 经纬度网格
        let gridHelper = null;
        
        // 创建地球
        function createEarth() {
            const geometry = new THREE.SphereGeometry(EARTH_RADIUS, 64, 64);
            const texture = new THREE.TextureLoader().load('https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg');
            const material = new THREE.MeshBasicMaterial({ 
                map: texture,
                overdraw: 0.5
            });
            const earth = new THREE.Mesh(geometry, material);
            
            // 添加赤道线
            const equatorGeometry = new THREE.TorusGeometry(EARTH_RADIUS * 1.001, 10, 16, 100);
            const equatorMaterial = new THREE.MeshBasicMaterial({ color: 0xffff00 });
            const equator = new THREE.Mesh(equatorGeometry, equatorMaterial);
            equator.rotation.x = Math.PI / 2;
            earth.add(equator);
            
            scene.add(earth);
            return earth;
        }
        
        // 创建经纬度网格
        function createGrid() {
            // 移除现有网格
            if (gridHelper) {
                scene.remove(gridHelper);
            }
            
            gridHelper = new THREE.Group();
            
            // 经线（子午线）- 每15度一条
            for (let lon = -180; lon < 180; lon += 15) {
                const points = [];
                for (let lat = -90; lat <= 90; lat += 1) {
                    const phi = THREE.MathUtils.degToRad(90 - lat);
                    const theta = THREE.MathUtils.degToRad(lon);
                    
                    points.push(new THREE.Vector3(
                        EARTH_RADIUS * Math.sin(phi) * Math.cos(theta),
                        EARTH_RADIUS * Math.cos(phi),
                        EARTH_RADIUS * Math.sin(phi) * Math.sin(theta)
                    ));
                }
                
                const geometry = new THREE.BufferGeometry().setFromPoints(points);
                const material = new THREE.LineBasicMaterial({ 
                    color: 0x3366ff, 
                    transparent: true,
                    opacity: 0.3
                });
                const meridian = new THREE.Line(geometry, material);
                gridHelper.add(meridian);
            }
            
            // 纬线 - 每15度一条
            for (let lat = -75; lat <= 75; lat += 15) {
                const points = [];
                for (let lon = -180; lon <= 180; lon += 1) {
                    const phi = THREE.MathUtils.degToRad(90 - lat);
                    const theta = THREE.MathUtils.degToRad(lon);
                    
                    points.push(new THREE.Vector3(
                        EARTH_RADIUS * Math.sin(phi) * Math.cos(theta),
                        EARTH_RADIUS * Math.cos(phi),
                        EARTH_RADIUS * Math.sin(phi) * Math.sin(theta)
                    ));
                }
                
                const geometry = new THREE.BufferGeometry().setFromPoints(points);
                const material = new THREE.LineBasicMaterial({ 
                    color: 0x33cc33, 
                    transparent: true,
                    opacity: 0.3
                });
                const parallel = new THREE.Line(geometry, material);
                gridHelper.add(parallel);
            }
            
            scene.add(gridHelper);
            
            return gridHelper;
        }
        
        // 创建小型天线模型
        function createAntenna(color, stationType) {
            const group = new THREE.Group();
            group.userData.stationType = stationType;
            
            // 底座
            const baseGeometry = new THREE.CylinderGeometry(50, 80, 40, 16);
            const baseMaterial = new THREE.MeshPhongMaterial({ color: 0x888888 });
            const base = new THREE.Mesh(baseGeometry, baseMaterial);
            group.add(base);
            
            // 天线
            const geometry = new THREE.ConeGeometry(100, 300, 16);
            const material = new THREE.MeshPhongMaterial({ color: color });
            const antenna = new THREE.Mesh(geometry, material);
            antenna.position.y = 150;
            antenna.rotation.x = Math.PI;
            group.add(antenna);
            
            return group;
        }
        
        // 创建更真实的卫星模型
        function createSatellite() {
            const group = new THREE.Group();
            group.name = "satellite";
            
            // 卫星主体 - 长方体
            const bodyGeometry = new THREE.BoxGeometry(300, 200, 400);
            const bodyMaterial = new THREE.MeshPhongMaterial({ 
                color: 0xaaaaaa,
                emissive: 0x333333,
                emissiveIntensity: 0.3
            });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            group.add(body);
            
            // 太阳能板
            const solarPanelGeometry = new THREE.BoxGeometry(800, 10, 400);
            const solarPanelMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x2255aa,
                emissive: 0x111111,
                emissiveIntensity: 0.2
            });
            const solarPanel1 = new THREE.Mesh(solarPanelGeometry, solarPanelMaterial);
            solarPanel1.position.x = 550;
            group.add(solarPanel1);
            
            const solarPanel2 = new THREE.Mesh(solarPanelGeometry, solarPanelMaterial);
            solarPanel2.position.x = -550;
            group.add(solarPanel2);
            
            // 通信天线
            const antennaGeometry = new THREE.CylinderGeometry(30, 100, 200, 32);
            const antennaMaterial = new THREE.MeshPhongMaterial({ color: 0xcccccc });
            const antenna1 = new THREE.Mesh(antennaGeometry, antennaMaterial);
            antenna1.position.z = 250;
            antenna1.rotation.x = Math.PI / 2;
            group.add(antenna1);
            
            // 卫星名称标签
            const textSprite = makeTextSprite("自定义卫星", { fontsize: 80 });
            textSprite.position.set(0, 300, 0);
            group.add(textSprite);
            
            return group;
        }
        
        // 创建文本精灵
        function makeTextSprite(message, parameters) {
            if (parameters === undefined) parameters = {};
            
            const fontface = parameters.fontface || 'Arial';
            const fontsize = parameters.fontsize || 70;
            const borderThickness = parameters.borderThickness || 4;
            const borderColor = parameters.borderColor || { r:0, g:0, b:0, a:1.0 };
            const backgroundColor = parameters.backgroundColor || { r:0, g:0, b:0, a:0.8 };
            const textColor = parameters.textColor || { r:255, g:255, b:255, a:1.0 };
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            context.font = "Bold " + fontsize + "px " + fontface;
            
            // 计算文本宽度
            const metrics = context.measureText(message);
            const textWidth = metrics.width;
            
            // 设置画布尺寸
            canvas.width = textWidth + borderThickness * 2;
            canvas.height = fontsize * 1.4 + borderThickness * 2;
            context.font = "Bold " + fontsize + "px " + fontface;
            
            // 文本背景
            context.fillStyle = "rgba(" + backgroundColor.r + "," + backgroundColor.g + ","
                          + backgroundColor.b + "," + backgroundColor.a + ")";
            context.strokeStyle = "rgba(" + borderColor.r + "," + borderColor.g + ","
                          + borderColor.b + "," + borderColor.a + ")";
            context.lineWidth = borderThickness;
            roundRect(context, borderThickness/2, borderThickness/2, 
                 textWidth + borderThickness, fontsize * 1.4 + borderThickness, 8);
            
            // 文本
            context.fillStyle = "rgba(" + textColor.r + "," + textColor.g + ","
                          + textColor.b + "," + textColor.a + ")";
            context.fillText(message, borderThickness, fontsize + borderThickness);
            
            // 创建纹理
            const texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;
            
            const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
            const sprite = new THREE.Sprite(spriteMaterial);
            sprite.scale.set(10, 5, 1.0);
            
            return sprite;
        }
        
        // 绘制圆角矩形
        function roundRect(ctx, x, y, w, h, r) {
            ctx.beginPath();
            ctx.moveTo(x+r, y);
            ctx.lineTo(x+w-r, y);
            ctx.quadraticCurveTo(x+w, y, x+w, y+r);
            ctx.lineTo(x+w, y+h-r);
            ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h);
            ctx.lineTo(x+r, y+h);
            ctx.quadraticCurveTo(x, y+h, x, y+h-r);
            ctx.lineTo(x, y+r);
            ctx.quadraticCurveTo(x, y, x+r, y);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();   
        }
        
        // 创建地面站标签
        function createStationLabel(type) {
            const label = document.createElement('div');
            label.className = 'station-label draggable';
            label.id = type + '-label';
            label.textContent = type === 'uplink' ? '上行站' : '接收站';
            document.body.appendChild(label);
            return label;
        }
        
        // 更新地面站标签位置
        function updateStationLabels() {
            // 更新上行站标签
            const upStationVector = new THREE.Vector3();
            upStationVector.setFromMatrixPosition(upStation.matrixWorld);
            upStationVector.project(camera);
            
            const upLabel = document.getElementById('uplink-label');
            if (upLabel) {
                upLabel.style.left = (upStationVector.x * 0.5 + 0.5) * window.innerWidth + 'px';
                upLabel.style.top = (-upStationVector.y * 0.5 + 0.5) * window.innerHeight - 40 + 'px';
            }
            
            // 更新下行站标签
            const downStationVector = new THREE.Vector3();
            downStationVector.setFromMatrixPosition(downStation.matrixWorld);
            downStationVector.project(camera);
            
            const downLabel = document.getElementById('downlink-label');
            if (downLabel) {
                downLabel.style.left = (downStationVector.x * 0.5 + 0.5) * window.innerWidth + 'px';
                downLabel.style.top = (-downStationVector.y * 0.5 + 0.5) * window.innerHeight - 40 + 'px';
            }
        }
        
        // 创建通信链路
        function createLinkLine(color) {
            const material = new THREE.LineBasicMaterial({ 
                color: color, 
                linewidth: 2,
                transparent: true,
                opacity: 0.8 
            });
            const geometry = new THREE.BufferGeometry();
            const line = new THREE.Line(geometry, material);
            return line;
        }
        
        // 计算链路参数 - 基础版本
        function calculateLinkParameters(groundPos, satPos, frequency, txPower, txAntennaDiam, rxAntennaDiam) {
            // 计算距离(km)
            const distance = groundPos.distanceTo(satPos);
            
            // 计算传播延迟(ms)
            const delay = (distance / 300000) * 1000; // 光速约300,000 km/s
            
            // 计算自由空间损耗(dB)
            const wavelength = 300 / frequency; // 波长(mm)
            const fsl = 20 * Math.log10(distance) + 20 * Math.log10(frequency) + 92.45;
            
            // 计算天线增益(dBi)
            const txGain = 20 * Math.log10(txAntennaDiam) + 20 * Math.log10(frequency) + 17.8;
            const rxGain = 20 * Math.log10(rxAntennaDiam) + 20 * Math.log10(frequency) + 17.8;
            
            // 计算SFDref (假设值)
            const sfdRef = (-90 + (frequency / 12) * 5).toFixed(1);
            
            return {
                distance: distance.toFixed(2),
                delay: delay.toFixed(2),
                fsl: fsl.toFixed(2),
                txGain: txGain.toFixed(2),
                rxGain: rxGain.toFixed(2),
                sfdRef: sfdRef
            };
        }
        
        // 集成链路计算相关算法 - 详细版本
        function calculateLinkBudget() {
            // 获取所有参数
            const frequency = parseFloat(document.getElementById('frequency').value); // GHz
            const txPower = parseFloat(document.getElementById('txPower').value); // W
            const txAntenna = parseFloat(document.getElementById('txAntenna').value); // m
            const rxAntenna = parseFloat(document.getElementById('rxAntenna').value); // m
            const bandwidth = parseFloat(document.getElementById('bandwidth').value); // MHz
            const modulation = document.getElementById('modulationType').value; // 调制方式
            const fec = document.getElementById('FEC').value; // 前向纠错码率
            
            // 获取上下行站和卫星位置
            const upStationPos = upStation.position.clone();
            const downStationPos = downStation.position.clone();
            const satPos = satellite.position.clone();
            
            // 计算上行链路参数
            const uplinkParams = calculateLinkParameters(
                upStationPos, 
                satPos, 
                frequency, 
                txPower, 
                txAntenna, 
                rxAntenna
            );
            
            // 计算下行链路参数
            const downlinkParams = calculateLinkParameters(
                downStationPos, 
                satPos, 
                frequency, 
                txPower, 
                txAntenna, 
                rxAntenna
            );
            
            // 更新链路信息显示
            document.getElementById('uplink-distance').textContent = uplinkParams.distance;
            document.getElementById('downlink-distance').textContent = downlinkParams.distance;
            document.getElementById('delay').textContent = (parseFloat(uplinkParams.delay) + parseFloat(downlinkParams.delay)).toFixed(2);
            document.getElementById('uplink-fsl').textContent = uplinkParams.fsl;
            document.getElementById('downlink-fsl').textContent = downlinkParams.fsl;
            
            // 计算EIRP (dBW)
            const txGain = parseFloat(uplinkParams.txGain);
            const eirp = 10 * Math.log10(txPower) + txGain;
            
            // 计算系统噪声温度和噪声系数
            const noiseTempUp = 290; // K
            const noiseTempDown = 120; // K
            
            // 计算C/N比
            const bandwidthHz = bandwidth * 1e6; // MHz转Hz
            const boltzmann = -228.6; // dBW/Hz/K
            
            // 上行C/N计算
            const uplinkCN = eirp - uplinkParams.fsl + txGain - (boltzmann + 10 * Math.log10(noiseTempUp) + 10 * Math.log10(bandwidthHz));
            
            // 下行C/N计算
            const satelliteEIRP = 20; // 假设卫星EIRP为20dBW
            const downlinkCN = satelliteEIRP - downlinkParams.fsl + parseFloat(downlinkParams.rxGain) - (boltzmann + 10 * Math.log10(noiseTempDown) + 10 * Math.log10(bandwidthHz));
            
            // 总体C/N
            const totalCN = 10 * Math.log10(1 / ((1 / Math.pow(10, uplinkCN / 10)) + (1 / Math.pow(10, downlinkCN / 10))));
            
            // 计算所需Eb/N0（基于调制方式和FEC）
            let requiredEbNo = 0;
            switch(modulation) {
                case 'BPSK':
                    requiredEbNo = 4.5;
                    break;
                case 'QPSK':
                    requiredEbNo = 6.5;
                    break;
                case '8PSK':
                    requiredEbNo = 8.5;
                    break;
                case '16QAM':
                    requiredEbNo = 10.5;
                    break;
                default:
                    requiredEbNo = 6.5; // 默认QPSK
            }
            
            // 根据FEC调整所需Eb/N0
            const fecMap = {
                '1/2': 0,
                '2/3': 1.5,
                '3/4': 2.5,
                '5/6': 3.5,
                '7/8': 4.0,
                '9/10': 4.5
            };
            
            requiredEbNo += fecMap[fec] || 0;
            
            // 计算符号率、比特率和频谱效率
            const fecRate = eval(fec); // 将字符串如"3/4"转换为数值
            let bitsPerSymbol = 1;
            switch(modulation) {
                case 'BPSK':
                    bitsPerSymbol = 1;
                    break;
                case 'QPSK':
                    bitsPerSymbol = 2;
                    break;
                case '8PSK':
                    bitsPerSymbol = 3;
                    break;
                case '16QAM':
                    bitsPerSymbol = 4;
                    break;
            }
            
            const spectralEfficiency = bitsPerSymbol * fecRate;
            const bitRate = bandwidth * 1e6 * spectralEfficiency;
            
            // 计算实际Eb/N0
            const ebno = totalCN + 10 * Math.log10(bandwidth * 1e6 / bitRate);
            
            // 计算链路余量
            const margin = ebno - requiredEbNo;
            
            // 估算误码率
            let ber;
            if (ebno <= 0) {
                ber = "0.5";
            } else if (ebno >= 20) {
                ber = "< 10⁻¹⁰";
            } else {
                // 简化的BER模型（实际应根据调制方式和编码精确计算）
                const exponent = Math.min(20, Math.floor(ebno * spectralEfficiency / 2));
                ber = `~ 10⁻${exponent}`;
            }
            
            // 更新结果显示
            document.getElementById('ebno').textContent = ebno.toFixed(2);
            document.getElementById('ber').textContent = ber;
            document.getElementById('margin').textContent = margin.toFixed(2);
            document.getElementById('cnr-up').textContent = uplinkCN.toFixed(2);
            document.getElementById('cnr-down').textContent = downlinkCN.toFixed(2);
            document.getElementById('cnr-total').textContent = totalCN.toFixed(2);
            
            // 更新表格显示
            document.getElementById('table-uplink-distance').textContent = uplinkParams.distance + ' km';
            document.getElementById('table-downlink-distance').textContent = downlinkParams.distance + ' km';
            document.getElementById('table-uplink-fsl').textContent = uplinkParams.fsl + ' dB';
            document.getElementById('table-downlink-fsl').textContent = downlinkParams.fsl + ' dB';
            document.getElementById('table-uplink-delay').textContent = uplinkParams.delay + ' ms';
            document.getElementById('table-downlink-delay').textContent = downlinkParams.delay + ' ms';
            document.getElementById('table-cnr-up').textContent = uplinkCN.toFixed(2) + ' dB';
            document.getElementById('table-cnr-down').textContent = downlinkCN.toFixed(2) + ' dB';
            document.getElementById('table-cnr-total').textContent = totalCN.toFixed(2) + ' dB';
            document.getElementById('table-ebno').textContent = ebno.toFixed(2) + ' dB';
            document.getElementById('table-ber').textContent = ber;
            document.getElementById('table-margin').textContent = margin.toFixed(2) + ' dB';
            
            // 更新链路质量指示器
            updateLinkQualityIndicators(ebno, margin);
            
            return {
                ebno: ebno.toFixed(2),
                ber: ber,
                margin: margin.toFixed(2),
                cnrUp: uplinkCN.toFixed(2),
                cnrDown: downlinkCN.toFixed(2),
                cnrTotal: totalCN.toFixed(2),
                uplinkDistance: uplinkParams.distance,
                downlinkDistance: downlinkParams.distance,
                uplinkFsl: uplinkParams.fsl,
                downlinkFsl: downlinkParams.fsl,
                delay: (parseFloat(uplinkParams.delay) + parseFloat(downlinkParams.delay)).toFixed(2)
            };
        }
        
        // 更新链路质量指示器颜色
        function updateLinkQualityIndicators(ebno, margin) {
            // Eb/N0指示器
            const ebnoIndicator = document.getElementById('ebno-indicator');
            if (ebno >= 12) {
                ebnoIndicator.className = 'link-quality-indicator link-quality-good';
            } else if (ebno >= 8) {
                ebnoIndicator.className = 'link-quality-indicator link-quality-medium';
            } else {
                ebnoIndicator.className = 'link-quality-indicator link-quality-poor';
            }
            
            // 链路余量指示器
            const marginIndicator = document.getElementById('margin-indicator');
            if (margin >= 3) {
                marginIndicator.className = 'link-quality-indicator link-quality-good';
            } else if (margin >= 1) {
                marginIndicator.className = 'link-quality-indicator link-quality-medium';
            } else {
                marginIndicator.className = 'link-quality-indicator link-quality-poor';
            }
        }
        
        // 生成打印报告的函数
        function generatePrintView() {
            // 创建一个新窗口
            const printWindow = window.open('', '_blank', 'width=800,height=800');
            
            // 获取当前卫星名称
            const satelliteName = document.getElementById('satelliteSelector').value;
            
            // 获取链路计算结果
            const results = {
                ebno: document.getElementById('ebno').textContent,
                ber: document.getElementById('ber').textContent,
                margin: document.getElementById('margin').textContent,
                cnrUp: document.getElementById('cnr-up').textContent,
                cnrDown: document.getElementById('cnr-down').textContent,
                cnrTotal: document.getElementById('cnr-total').textContent,
                uplinkDistance: document.getElementById('uplink-distance').textContent,
                downlinkDistance: document.getElementById('downlink-distance').textContent,
                uplinkFsl: document.getElementById('uplink-fsl').textContent,
                downlinkFsl: document.getElementById('downlink-fsl').textContent,
                delay: document.getElementById('delay').textContent
            };
            
            // 获取其他参数
            const params = {
                frequency: document.getElementById('frequencyValue').textContent,
                bandwidth: document.getElementById('bandwidthValue').textContent,
                txPower: document.getElementById('txPowerValue').textContent,
                txAntenna: document.getElementById('txAntennaValue').textContent,
                rxAntenna: document.getElementById('rxAntennaValue').textContent,
                upLatitude: document.getElementById('upLatitudeValue').textContent,
                upLongitude: document.getElementById('upLongitudeValue').textContent,
                downLatitude: document.getElementById('downLatitudeValue').textContent,
                downLongitude: document.getElementById('downLongitudeValue').textContent,
                modulation: document.getElementById('modulationType').value,
                fec: document.getElementById('FEC').value,
                polarization: document.getElementById('uplinkPolarization').value
            };
            
            // 构建报告内容
            let reportContent = `
                <div style="max-width: 800px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h1 style="font-size: 24pt; color: #2C3E50; margin-bottom: 5px;">
                            ${satelliteName} 卫星链路预算报告
                        </h1>
                        <p style="color: #7F8C8D; font-size: 10pt;">
                            生成时间: ${new Date().toLocaleString()}
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div class="report-link-section">
                            <div class="report-link-header">
                                <h2 style="margin: 0; font-size: 14pt; color: #2980B9;">链路计算结果</h2>
                            </div>
                            <div style="margin: 10px 0; display: flex; flex-wrap: wrap;">
                                <span style="margin-right: 15px;"><strong>Eb/N₀:</strong> ${results.ebno} dB</span> 
                                <span style="margin-right: 15px;"><strong>误码率:</strong> ${results.ber}</span>                  
                                <span><strong>链路余量:</strong> ${results.margin} dB</span>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 5px; padding: 8px;">
                                <div style="display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding: 3px 0;">
                                    <span style="color: #555;">上行C/N:</span>
                                    <span style="font-family: 'Courier New', monospace;">${results.cnrUp} dB</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding: 3px 0;">
                                    <span style="color: #555;">下行C/N:</span>
                                    <span style="font-family: 'Courier New', monospace;">${results.cnrDown} dB</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding: 3px 0;">
                                    <span style="color: #555;">总C/N:</span>
                                    <span style="font-family: 'Courier New', monospace;">${results.cnrTotal} dB</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding: 3px 0;">
                                    <span style="color: #555;">上行距离:</span>
                                    // 生成打印报告的函数 (继续)
    <span style="font-family: 'Courier New', monospace;">${results.uplinkDistance} km</span>
</div>
<div style="display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding: 3px 0;">
    <span style="color: #555;">下行距离:</span>
    <span style="font-family: 'Courier New', monospace;">${results.downlinkDistance} km</span>
</div>
<div style="display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding: 3px 0;">
    <span style="color: #555;">上行自由空间损耗:</span>
    <span style="font-family: 'Courier New', monospace;">${results.uplinkFsl} dB</span>
</div>
<div style="display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding: 3px 0;">
    <span style="color: #555;">下行自由空间损耗:</span>
    <span style="font-family: 'Courier New', monospace;">${results.downlinkFsl} dB</span>
</div>
<div style="display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding: 3px 0;">
    <span style="color: #555;">总延迟:</span>
    <span style="font-family: 'Courier New', monospace;">${results.delay} ms</span>
</div>
</div>
</div>

<div class="report-link-section">
<div class="report-link-header">
    <h2 style="margin: 0; font-size: 14pt; color: #2980B9;">链路参数</h2>
</div>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 5px; padding: 8px;">
    <div style="display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding: 3px 0;">
        <span style="color: #555;">卫星名称:</span>
        <span style="font-family: 'Courier New', monospace;">${satelliteName}</span>
    </div>
    <div style="display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding: 3px 0;">
        <span style="color: #555;">频率:</span>
        <span style="font-family: 'Courier New', monospace;">${params.frequency} GHz</span>
    </div>
    <div style="display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding: 3px 0;">
        <span style="color: #555;">带宽:</span>
        <span style="font-family: 'Courier New', monospace;">${params.bandwidth} MHz</span>
    </div>
    <div style="display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding: 3px 0;">
        <span style="color: #555;">发射功率:</span>
        <span style="font-family: 'Courier New', monospace;">${params.txPower} W</span>
    </div>
    <div style="display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding: 3px 0;">
        <span style="color: #555;">发射天线直径:</span>
        <span style="font-family: 'Courier New', monospace;">${params.txAntenna} m</span>
    </div>
    <div style="display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding: 3px 0;">
        <span style="color: #555;">接收天线直径:</span>
        <span style="font-family: 'Courier New', monospace;">${params.rxAntenna} m</span>
    </div>
    <div style="display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding: 3px 0;">
        <span style="color: #555;">上行站纬度:</span>
        <span style="font-family: 'Courier New', monospace;">${params.upLatitude}°</span>
    </div>
    <div style="display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding: 3px 0;">
        <span style="color: #555;">上行站经度:</span>
        <span style="font-family: 'Courier New', monospace;">${params.upLongitude}°</span>
    </div>
    <div style="display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding: 3px 0;">
        <span style="color: #555;">接收站纬度:</span>
        <span style="font-family: 'Courier New', monospace;">${params.downLatitude}°</span>
    </div>
    <div style="display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding: 3px 0;">
        <span style="color: #555;">接收站经度:</span>
        <span style="font-family: 'Courier New', monospace;">${params.downLongitude}°</span>
    </div>
    <div style="display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding: 3px 0;">
        <span style="color: #555;">调制方式:</span>
        <span style="font-family: 'Courier New', monospace;">${params.modulation}</span>
    </div>
    <div style="display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding: 3px 0;">
        <span style="color: #555;">前向纠错码率:</span>
        <span style="font-family: 'Courier New', monospace;">${params.fec}</span>
    </div>
    <div style="display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding: 3px 0;">
        <span style="color: #555;">上行极化:</span>
        <span style="font-family: 'Courier New', monospace;">${params.polarization}</span>
    </div>
</div>
</div>
</div>

<div style="margin-top: 15px; text-align: center; font-size: 8pt; color: #888; border-top: 1px solid #eee; padding-top: 8px;">
报告生成时间: ${new Date().toLocaleString()} • 用户: ${params.user || 'piaosir'} • 仅供参考，实际结果可能因工作环境而异
</div>

<div style="display: block; position: fixed; bottom: 15px; right: 15px;">
<button onclick="window.print()" style="padding: 4px 10px; background: #2C3E50; color: white; border: none; border-radius: 2px; cursor: pointer; font-size: 13pt;">打印报告</button>
<button onclick="window.close()" style="padding: 4px 10px; background: #666; color: white; border: none; border-radius: 2px; cursor: pointer; font-size: 13pt; margin-left: 5px;">关闭并返回</button>
</div>
</div>

<style>
@page {
    size: A4;
    margin: 1cm;
}
@media print {
    button {
        display: none !important;
    }
    body {
        padding: 0;
        font-size: 8pt !important;
    }
}
</style>
`;

// 写入报告内容到新窗口
printWindow.document.write(`
<html>
    <head>
        <title>${satelliteName} 卫星链路预算报告</title>
        <meta charset="UTF-8">
    </head>
    <body style="margin: 0; padding: 0;">
        ${reportContent}
    </body>
</html>
`);

// 关闭文档流
printWindow.document.close();
}

// 创建场景对象
const earth = createEarth();
const upStation = createAntenna(0x00ff00, 'uplink'); // 绿色上行站
const downStation = createAntenna(0xff0000, 'downlink'); // 红色接收站
const satellite = createSatellite();
const uplinkLine = createLinkLine(0x00ff00); // 绿色上行链路
const downlinkLine = createLinkLine(0xff0000); // 红色下行链路

scene.add(upStation);
scene.add(downStation);
scene.add(satellite);
scene.add(uplinkLine);
scene.add(downlinkLine);

// 创建地面站标签
const uplinkLabel = createStationLabel('uplink');
const downlinkLabel = createStationLabel('downlink');

// 卫星信息显示元素
const satelliteInfo = document.getElementById('satellite-info');

// 卫星交互状态
let isDragging = false;
let isSatelliteFocused = false;
let isPositionLocked = false;
let currentAngle = THREE.MathUtils.degToRad(-116.4); // 初始位置对应北京经度
let initialShowInstructions = true;
let currentSatelliteName = "自定义卫星";

// 地面站拖拽功能
let isDraggingStation = false;
let draggedStation = null;

// 更新卫星标签文本
function updateSatelliteLabel(name) {
    // 移除现有标签
    satellite.children.forEach(child => {
        if (child instanceof THREE.Sprite) {
            satellite.remove(child);
        }
    });
    
    // 添加新标签
    const textSprite = makeTextSprite(name, { fontsize: 80 });
    textSprite.position.set(0, 300, 0);
    satellite.add(textSprite);
    
    // 更新下拉选择框中的显示
    document.getElementById('satelliteSelector').value = name;
}

// 显示操作指南
function showInstructions() {
    document.getElementById('instruction-panel').style.display = 'block';
}

// 关闭操作指南
document.getElementById('closeInstructions').addEventListener('click', function() {
    document.getElementById('instruction-panel').style.display = 'none';
    initialShowInstructions = false;
});

// 初始化面板切换功能
function initPanelToggle() {
    const toggleBtn = document.getElementById('togglePanel');
    
    toggleBtn.addEventListener('click', function() {
        document.body.classList.toggle('panel-hidden');
        updateStationLabels();
    });
}

// 初始化分区折叠功能
function toggleSection(sectionId) {
    const section = document.getElementById(sectionId).parentElement;
    section.classList.toggle('section-collapsed');
}

// 初始化地面站拖拽功能
function initStationDragging() {
    // 为地面站添加拖拽功能
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    
    document.addEventListener('mousedown', function(event) {
        // 先检查是否点击了地面站
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        
        raycaster.setFromCamera(mouse, camera);
        
        const intersects = raycaster.intersectObject(upStation, true).concat(
            raycaster.intersectObject(downStation, true)
        );
        
        if (intersects.length > 0) {
            const hitObject = intersects[0].object.parent;
            isDraggingStation = true;
            draggedStation = hitObject.userData.stationType;
            controls.enabled = false; // 禁用相机控制
            
            // 显示拖拽提示
            showDragInfo(draggedStation);
        }
    });
    
    document.addEventListener('mousemove', function(event) {
        if (!isDraggingStation) return;
        
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        
        raycaster.setFromCamera(mouse, camera);
        
        // 计算与地球表面的交点
        const earthSphere = new THREE.Sphere(new THREE.Vector3(0, 0, 0), EARTH_RADIUS);
        const earthIntersects = new THREE.Vector3();
        raycaster.ray.intersectSphere(earthSphere, earthIntersects);
        
        if (earthIntersects) {
            // 更新地面站位置
            const station = draggedStation === 'uplink' ? upStation : downStation;
            station.position.copy(earthIntersects);
            
            // 让天线指向天空
            station.lookAt(0, station.position.y * 2, 0);
            
            // 计算新的经纬度
            const lat = Math.asin(earthIntersects.y / EARTH_RADIUS) * (180 / Math.PI);
            const lon = Math.atan2(earthIntersects.z, earthIntersects.x) * (180 / Math.PI);
            
            // 更新UI控件
            if (draggedStation === 'uplink') {
                document.getElementById('upLatitude').value = lat;
                document.getElementById('upLongitude').value = lon;
                document.getElementById('upLatitudeValue').textContent = lat.toFixed(2);
                document.getElementById('upLongitudeValue').textContent = lon.toFixed(2);
            } else {
                document.getElementById('downLatitude').value = lat;
                document.getElementById('downLongitude').value = lon;
                document.getElementById('downLatitudeValue').textContent = lat.toFixed(2);
                document.getElementById('downLongitudeValue').textContent = lon.toFixed(2);
            }
            
            // 更新链路线
            updateLinkLines();
            
            // 更新地面站标签位置
            updateStationLabels();
            
            // 更新计算结果
            updateLinkParameters();
        }
    });
    
    document.addEventListener('mouseup', function() {
        if (isDraggingStation) {
            isDraggingStation = false;
            draggedStation = null;
            controls.enabled = true; // 重新启用相机控制
            hideDragInfo();
            
            // 更新表格显示
            updateTableValues();
        }
    });
}

function showDragInfo(stationType) {
    const stationName = stationType === 'uplink' ? '上行站' : '接收站';
    
    // 创建或更新拖拽提示
    let dragInfo = document.getElementById('drag-info');
    if (!dragInfo) {
        dragInfo = document.createElement('div');
        dragInfo.id = 'drag-info';
        dragInfo.style.position = 'absolute';
        dragInfo.style.top = '50%';
        dragInfo.style.left = '50%';
        dragInfo.style.transform = 'translate(-50%, -50%)';
        dragInfo.style.background = 'rgba(0,0,0,0.7)';
        dragInfo.style.color = 'white';
        dragInfo.style.padding = '10px 20px';
        dragInfo.style.borderRadius = '5px';
        dragInfo.style.zIndex = '1000';
        document.body.appendChild(dragInfo);
    }
    
    dragInfo.textContent = `正在拖动${stationName}，移动到地球表面的目标位置`;
    dragInfo.style.display = 'block';
}

function hideDragInfo() {
    const dragInfo = document.getElementById('drag-info');
    if (dragInfo) {
        dragInfo.style.display = 'none';
    }
}

// 初始化快捷操作按钮
function initQuickActions() {
    // 计算按钮
    document.getElementById('quick-calculate').addEventListener('click', function() {
        calculateLinkBudget();
    });
    
    // 重置视角按钮
    document.getElementById('quick-reset').addEventListener('click', function() {
        camera.position.set(0, 20000, 30000);
        camera.lookAt(0, 0, 0);
        controls.update();
    });
    
    // 生成报告按钮
    document.getElementById('quick-report').addEventListener('click', function() {
        generatePrintView();
    });
}

// 更新表格中的值
function updateTableValues() {
    // 获取最新计算结果
    const results = calculateLinkBudget();
}

// 卫星选择处理
document.getElementById('satelliteSelector').addEventListener('change', function() {
    const selectedSatellite = this.value;
    currentSatelliteName = selectedSatellite;
    
    // 更新卫星位置
    if (satellitePositions[selectedSatellite] !== undefined) {
        currentAngle = THREE.MathUtils.degToRad(-satellitePositions[selectedSatellite]);
        updateSatellitePosition();
        updateSatelliteLabel(selectedSatellite);
        updateLinkLines();
        updateLinkParameters();
    }
});

// 鼠标事件处理
function onMouseDown(event) {
    // 检查是否点击了卫星
    const mouse = new THREE.Vector2(
        (event.clientX / window.innerWidth) * 2 - 1,
        -(event.clientY / window.innerHeight) * 2 + 1
    );
    
    const raycaster = new THREE.Raycaster();
    raycaster.setFromCamera(mouse, camera);
    
    const intersects = raycaster.intersectObject(satellite, true);
    
    if (intersects.length > 0) {
        if (isPositionLocked) {
            // 如果位置已锁定，显示提示信息
            satelliteInfo.textContent = "位置已锁定，双击解锁";
            satelliteInfo.style.backgroundColor = "rgba(255,0,0,0.7)";
            setTimeout(() => {
                satelliteInfo.style.backgroundColor = "rgba(0,0,0,0.7)";
            }, 1000);
            return;
        }
        
        isDragging = true;
        isSatelliteFocused = true;
        satellite.children.forEach(child => {
            if (child instanceof THREE.Mesh) {
                child.material.emissive.setHex(0xffff00);
                child.material.emissiveIntensity = 0.5;
            }
        });
        
        // 首次选中卫星时显示操作指南
        if (initialShowInstructions) {
            showInstructions();
        }
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
        
        // 禁用相机轨道控制
        controls.enabled = false;
    } else {
        // 点击其他地方取消聚焦
        if (isSatelliteFocused) {
            satellite.children.forEach(child => {
                if (child instanceof THREE.Mesh) {
                    child.material.emissive.setHex(0x333333);
                    child.material.emissiveIntensity = 0.3;
                }
            });
            isSatelliteFocused = false;
        }
        
        // 启用相机轨道控制
        controls.enabled = true;
    }
}

function onMouseMove(event) {
    if (isDragging && !isPositionLocked) {
        const mouse = new THREE.Vector2(
            (event.clientX / window.innerWidth) * 2 - 1,
            -(event.clientY / window.innerHeight) * 2 + 1
        );
        
        // 将相机空间中的射线转换到全局空间
        const raycaster = new THREE.Raycaster();
        raycaster.setFromCamera(mouse, camera);
        
        // 创建平面以提供更精确的移动
        const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
        const point = new THREE.Vector3();
        raycaster.ray.intersectPlane(plane, point);
        
        // 计算与原点的角度
        const angle = Math.atan2(point.z, point.x);
        currentAngle = angle;
        
        // 更新卫星位置
        updateSatellitePosition();
        
        // 更新链路
        updateLinkLines();
        
        // 计算并显示链路参数
        updateLinkParameters();
        
        // 更新卫星信息
        const degrees = THREE.MathUtils.radToDeg(-currentAngle);
        const formattedDegrees = formatLongitude(degrees);
        satelliteInfo.textContent = `轨道位置: ${formattedDegrees}`;
    }
    
    // 更新卫星信息显示位置
    updateSatelliteInfoPosition();
}

function onMouseUp() {
    isDragging = false;
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', onMouseUp);
    
    // 启用相机轨道控制
    controls.enabled = true;
    
    // 更新载波信息面板中的显示
    if (currentSatelliteName === "自定义卫星") {
        // 如果是自定义卫星，检查当前位置是否与已知卫星接近
        const degrees = THREE.MathUtils.radToDeg(-currentAngle) % 360;
        const longitude = degrees > 180 ? degrees - 360 : degrees;
        
        let matchFound = false;
        for (const [name, pos] of Object.entries(satellitePositions)) {
            if (name !== "自定义卫星" && Math.abs(longitude - pos) < 1) {
                currentSatelliteName = name;
                updateSatelliteLabel(name);
                matchFound = true;
                break;
            }
        }
        
        if (!matchFound) {
            updateSatelliteLabel("自定义卫星");
        }
    }
}

// 滚轮事件处理 - 微调卫星位置
function onMouseWheel(event) {
    if (isSatelliteFocused && !isPositionLocked) {
        // 聚焦卫星时，滚轮调整卫星位置
        event.preventDefault();
        
        // 微调角度 (±0.1度)
        const delta = event.deltaY > 0 ? -0.1 : 0.1;
        currentAngle += THREE.MathUtils.degToRad(delta);
        
        // 更新卫星位置
        updateSatellitePosition();
        
        // 更新链路
        updateLinkLines();
        
        // 计算并显示链路参数
        updateLinkParameters();
        
        // 更新卫星信息
        const degrees = THREE.MathUtils.radToDeg(-currentAngle);
        const formattedDegrees = formatLongitude(degrees);
        satelliteInfo.textContent = `轨道位置: ${formattedDegrees}（滚轮微调中）`;
    } else {
        // 未聚焦卫星时，正常缩放
    }
}

// 双击事件 - 锁定/解锁卫星位置
function onDoubleClick(event) {
    const mouse = new THREE.Vector2(
        (event.clientX / window.innerWidth) * 2 - 1,
        -(event.clientY / window.innerHeight) * 2 + 1
    );
    
    const raycaster = new THREE.Raycaster();
    raycaster.setFromCamera(mouse, camera);
    
    const intersects = raycaster.intersectObject(satellite, true);
    
    if (intersects.length > 0) {
        isPositionLocked = !isPositionLocked;
        
        if (isPositionLocked) {
            // 锁定位置 - 修改卫星外观
            satellite.children.forEach(child => {
                if (child instanceof THREE.Mesh) {
                    child.material.emissive.setHex(0xff0000);
                    child.material.emissiveIntensity = 0.3;
                }
            });
            satelliteInfo.textContent = "位置已锁定";
        } else {
            // 解锁位置
            satellite.children.forEach(child => {
                if (child instanceof THREE.Mesh) {
                    child.material.emissive.setHex(0xffff00);
                    child.material.emissiveIntensity = 0.5;
                }
            });
            satelliteInfo.textContent = "位置已解锁";
        }
        
        setTimeout(() => {
            const degrees = THREE.MathUtils.radToDeg(-currentAngle);
            const formattedDegrees = formatLongitude(degrees);
            satelliteInfo.textContent = `轨道位置: ${formattedDegrees}`;
        }, 1000);
    }
}

// 网格开关事件处理
document.getElementById('gridToggle').addEventListener('change', function(event) {
    if (event.target.checked) {
        createGrid();
    } else if (gridHelper) {
        scene.remove(gridHelper);
        gridHelper = null;
    }
});

document.addEventListener('mousedown', onMouseDown);
document.addEventListener('wheel', onMouseWheel, { passive: false });
document.addEventListener('dblclick', onDoubleClick);

// 更新卫星位置
function updateSatellitePosition() {
    const radius = EARTH_RADIUS + parseFloat(document.getElementById('orbitHeight').value);
    satellite.position.x = radius * Math.cos(currentAngle);
    satellite.position.z = radius * Math.sin(currentAngle);
    
    // 卫星始终面向地球
    satellite.lookAt(0, 0, 0);
}

// 更新地面站位置
function updateGroundStationsPosition() {
    // 上行站位置
    const upLat = parseFloat(document.getElementById('upLatitude').value);
    const upLon = parseFloat(document.getElementById('upLongitude').value);
    
    // 转换为三维坐标
    const upLatRad = THREE.MathUtils.degToRad(upLat);
    const upLonRad = THREE.MathUtils.degToRad(upLon);
    
    upStation.position.set(
        EARTH_RADIUS * Math.cos(upLatRad) * Math.cos(upLonRad),
        EARTH_RADIUS * Math.sin(upLatRad),
        EARTH_RADIUS * Math.cos(upLatRad) * Math.sin(upLonRad)
    );
    
    // 上行站始终朝上
    upStation.lookAt(0, EARTH_RADIUS * 2, 0);
    
    // 下行站位置
    const downLat = parseFloat(document.getElementById('downLatitude').value);
    const downLon = parseFloat(document.getElementById('downLongitude').value);
    
    // 转换为三维坐标
    const downLatRad = THREE.MathUtils.degToRad(downLat);
    const downLonRad = THREE.MathUtils.degToRad(downLon);
    
    downStation.position.set(
        EARTH_RADIUS * Math.cos(downLatRad) * Math.cos(downLonRad),
        EARTH_RADIUS * Math.sin(downLatRad),
        EARTH_RADIUS * Math.cos(downLatRad) * Math.sin(downLonRad)
    );
    
    // 下行站始终朝上
    downStation.lookAt(0, EARTH_RADIUS * 2, 0);
    
    // 更新地面站标签位置
    updateStationLabels();
}

// 更新链路线
function updateLinkLines() {
    // 更新上行链路
    const uplinkPoints = [
        upStation.position.clone(),
        satellite.position.clone()
    ];
    
    const uplinkGeometry = new THREE.BufferGeometry().setFromPoints(uplinkPoints);
    uplinkLine.geometry.dispose();
    uplinkLine.geometry = uplinkGeometry;
    
    // 更新下行链路
    const downlinkPoints = [
        satellite.position.clone(),
        downStation.position.clone()
    ];
    
    const downlinkGeometry = new THREE.BufferGeometry().setFromPoints(downlinkPoints);
    downlinkLine.geometry.dispose();
    downlinkLine.geometry = downlinkGeometry;
}

// 更新链路参数
function updateLinkParameters() {
    const frequency = parseFloat(document.getElementById('frequency').value);
    const txPower = parseFloat(document.getElementById('txPower').value);
    const txAntenna = parseFloat(document.getElementById('txAntenna').value);
    const rxAntenna = parseFloat(document.getElementById('rxAntenna').value);
    
    // 计算上行链路参数
    const uplinkParams = calculateLinkParameters(
        upStation.position, 
        satellite.position, 
        frequency, 
        txPower, 
        txAntenna, 
        rxAntenna
    );
    
    // 计算下行链路参数
    const downlinkParams = calculateLinkParameters(
        downStation.position, 
        satellite.position, 
        frequency, 
        txPower, 
        txAntenna, 
        rxAntenna
    );
    
    // 更新显示
    document.getElementById('uplink-distance').textContent = uplinkParams.distance;
    document.getElementById('downlink-distance').textContent = downlinkParams.distance;
    document.getElementById('delay').textContent = (parseFloat(uplinkParams.delay) + parseFloat(downlinkParams.delay)).toFixed(2);
    document.getElementById('uplink-fsl').textContent = uplinkParams.fsl;
    document.getElementById('downlink-fsl').textContent = downlinkParams.fsl;
}

// 格式化经度显示
function formatLongitude(degrees) {
    // 调整为0-360范围，然后转换为-180到180
    degrees = (degrees) % 360;
    if (degrees > 180) degrees -= 360;
    
    return degrees >= 0 ? `${degrees.toFixed(1)}°E` : `${(-degrees).toFixed(1)}°W`;
}

// 更新卫星信息显示位置
function updateSatelliteInfoPosition() {
    if (isSatelliteFocused) {
        const vector = new THREE.Vector3();
        vector.setFromMatrixPosition(satellite.matrixWorld);
        vector.project(camera);
        
        const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
        const y = (-vector.y * 0.5 + 0.5) * window.innerHeight;
        
        satelliteInfo.style.display = 'block';
        satelliteInfo.style.left = `${x}px`;
        satelliteInfo.style.top = `${y - 50}px`;
    } else {
        satelliteInfo.style.display = 'none';
    }
}

// 主初始化函数
function initialize() {
    // 初始位置设置
    updateSatellitePosition();
    updateGroundStationsPosition();
    updateLinkLines();
    updateLinkParameters();
    
    // 初始化交互功能
    initPanelToggle();
    initStationDragging();
    initQuickActions();
    
    // 计算按钮事件
    document.getElementById('calculateBtn').addEventListener('click', calculateLinkBudget);
    
    // 报告按钮事件
    document.getElementById('reportBtn').addEventListener('click', generatePrintView);
    
    // 初始更新表格
    updateTableValues();
    
    // 输入参数的事件监听
    document.querySelectorAll('#unified-control-panel input[type="range"]').forEach(slider => {
        slider.addEventListener('input', function() {
            // 更新显示值
            document.getElementById(`${this.id}Value`).textContent = this.value;
            
            // 根据修改的参数类型更新相应内容
            if (this.id === 'orbitHeight') {
                updateSatellitePosition();
            } else if (this.id.includes('Latitude') || this.id.includes('Longitude')) {
                updateGroundStationsPosition();
            }
            
            // 更新链路线和参数
            updateLinkLines();
            updateLinkParameters();
        });
    });
    
    // 设置初始折叠状态
    // 默认折叠部分面板
    document.querySelectorAll('.collapsible-section').forEach((section, index) => {
        // 第一个面板保持展开状态
        if (index > 0) {
            section.classList.add('section-collapsed');
        }
    });
}

// 窗口大小调整事件
window.addEventListener('resize', function() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    
    // 更新标签位置
    updateStationLabels();
});

// 动画循环
function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
    
    // 更新卫星标签位置
    updateSatelliteInfoPosition();
    updateStationLabels();
}

// 在页面加载完成后调用初始化
document.addEventListener('DOMContentLoaded', initialize);

// 启动动画
animate();
   </script>
</body>
</html>
